<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ask SANRI</title>

  <style>
    :root{
      --bg:#0e1116;
      --card:#141a22;
      --soft:#1b2230;
      --gold:#d6b36a;
      --text:#e9edf3;
      --muted:#9aa4b2;
      --accent:#6fa8ff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(1200px 600px at 50% -10%, #1a2030 0%, #0e1116 60%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .card{
      width:100%;
      max-width:820px;
      background:linear-gradient(180deg, #141a22, #0f141d);
      border:1px solid #20283a;
      border-radius:24px;
      padding:28px;
      box-shadow:0 30px 80px rgba(0,0,0,.45);
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      letter-spacing:.3px;
    }
    .brand .logo{
      width:34px; height:34px; border-radius:50%;
      background:linear-gradient(135deg, #2a3246, #121826);
      display:grid; place-items:center; color:var(--gold);
      border:1px solid #2b3450;
    }
    .brand .title{ font-weight:600; }
    .lang{ display:flex; gap:8px; }
    .lang button{
      background:transparent; border:1px solid #2b3450;
      color:var(--muted); border-radius:999px; padding:6px 10px; cursor:pointer;
    }
    .lang button.active{color:var(--gold); border-color:var(--gold)}

    h1{
      text-align:center;
      margin:12px 0 6px;
      font-size:42px;
      letter-spacing:1px;
      font-family: Georgia, "Times New Roman", serif;
    }
    .subtitle{ text-align:center; color:var(--muted); margin-bottom:18px; }

    .notice{
      background:linear-gradient(180deg, #151c2a, #101624);
      border:1px solid #2b3450;
      border-radius:14px;
      padding:12px 14px;
      color:#c9d2e3;
      margin:14px 0 22px;
    }
    .notice b{color:var(--gold)}

    .step{display:none}
    .step.active{display:block}

    .center{text-align:center}
    .muted{color:var(--muted)}
    .spacer{height:14px}

    .choices{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
    }
    .pill{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #2b3450;
      background:linear-gradient(180deg, #141a22, #0f141d);
      color:var(--text);
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(111,168,255,.15) inset;
      color:#fff;
    }

    .actions{
      display:flex; gap:12px; justify-content:center; margin-top:18px;
    }
    .btn{
      padding:12px 18px; border-radius:14px; cursor:pointer;
      border:1px solid #2b3450; background:var(--soft); color:#fff;
    }
    .btn.primary{
      background:linear-gradient(135deg, #6fa8ff, #7c8cff);
      border:none; color:#0b1020; font-weight:600;
    }

    textarea{
      width:100%;
      min-height:120px;
      background:#0f141d;
      border:1px solid #2b3450;
      border-radius:14px;
      color:#e9edf3;
      padding:14px;
      resize:vertical;
      outline:none;
    }

    .answer{
      margin-top:18px;
      background:#0f141d;
      border:1px solid #2b3450;
      border-radius:14px;
      padding:14px;
      white-space:pre-wrap;
    }
  </style>
  <meta name="theme-color" content="#0b0f1a">
</head>

<body>
  <div class="card">
    <header>
      <div class="brand">
        <div class="logo">∞</div>
        <div>
          <div class="title">CAELINUS</div>
          <div class="muted" style="font-size:12px">GODDESSES OF ANATOLIA</div>
        </div>
      </div>
      <div class="lang">
        <button id="trBtn" class="active" type="button">TR</button>
        <button id="enBtn" type="button">EN</button>
      </div>
    </header>

    <h1>Ask SANRI</h1>
    <div class="subtitle">CONSCIOUSNESS MIRROR</div>

    <div class="notice center">
      <b>Not:</b> SANRI kehanet, teşhis ya da yargı sunmaz.
      Sembolik anlam ve ucu açık sorular üretir.
      Anlam, her zaman senin içinde şekillenir.
    </div>

    <!-- STEP 1 -->
    <section id="step-1" class="step active center">
      <p><b>Bir an dur.</b></p>
      <p class="muted">
        Sorunu yazmadan önce, bunun bedende nerede hissedildiğine bak.<br/>
        Kalpte mi? Midede mi? Boğazda mı?
      </p>
      <div class="spacer"></div>
      <p class="muted">
        SANRI cevap vermek için değil,<br/>
        sorunun içindeki kapıyı açmak içindir.
      </p>
      <div class="actions">
        <button class="btn primary" type="button" id="readyBtn">Hazırım</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" class="step center">
      <p><b>Bir mod seç</b></p>
      <div class="choices" id="modeChoices">
        <button class="pill active" type="button" data-key="mode" data-val="Dream">Dream</button>
        <button class="pill" type="button" data-key="mode" data-val="Mirror">Mirror</button>
        <button class="pill" type="button" data-key="mode" data-val="Divine">Divine</button>
        <button class="pill" type="button" data-key="mode" data-val="Shadow">Shadow</button>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="back2">Geri</button>
        <button class="btn primary" type="button" id="next2">Devam</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" class="step center">
      <p><b>Alan seçimi (isteğe bağlı)</b></p>
      <div class="choices" id="fieldChoices">
        <button class="pill active" type="button" data-key="field" data-val="Auto">Auto</button>
        <button class="pill" type="button" data-key="field" data-val="Awakened Cities">Awakened Cities</button>
        <button class="pill" type="button" data-key="field" data-val="Consciousness Field">Consciousness Field</button>
        <button class="pill" type="button" data-key="field" data-val="Frequency Field">Frequency Field</button>
        <button class="pill" type="button" data-key="field" data-val="Ritual Space">Ritual Space</button>
        <button class="pill" type="button" data-key="field" data-val="Book 112">Book 112</button>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="back3">Geri</button>
        <button class="btn primary" type="button" id="next3">Devam</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step-4" class="step">
      <p class="center"><b>Sorunu yaz</b></p>
      <textarea id="question" placeholder="Buraya sorunu yaz..."></textarea>
      <div class="actions">
        <button class="btn" type="button" id="back4">Geri</button>
        <button class="btn primary" type="button" id="askBtn">Başla</button>
      </div>
      <div id="answer" class="answer" style="display:none"></div>
    </section>
  </div>

 <script>
(() => {
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const setActive = (id) => {
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    const el = $(id);
    if (el) el.classList.add("active");
  };

  // ---------- state ----------
  const state = {
    step: 1,
    mode: "Dream",
    field: "Auto",
    lang: "tr",
    session_id: null,
    domain: null
  };

  // ---------- step nav ----------
  function showStep(n){
    state.step = Math.max(1, Math.min(4, n));
    setActive(step-${state.step});
  }
  function nextStep(){ showStep(state.step + 1); }
  function prevStep(){ showStep(state.step - 1); }

  // ---------- pill picking (mode/field) ----------
  function wirePills(containerId){
    const container = $(containerId);
    if(!container) return;
    container.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill");
      if(!btn) return;
      const key = btn.dataset.key;
      const val = btn.dataset.val;
      if(!key) return;

      container.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      state[key] = val;
    });
  }

  // ---------- lang ----------
  function setLang(l){
    state.lang = l;
    const trBtn = $("trBtn");
    const enBtn = $("enBtn");
    if(trBtn) trBtn.classList.toggle("active", l === "tr");
    if(enBtn) enBtn.classList.toggle("active", l === "en");
  }
// ======= GATES LOADER (v1 + v2 merge, v2_ prefix) =======

async function fetchJson(path){
  const r = await fetch(path);
  if(!r.ok) throw new Error(path + " -> " + r.status);
  return r.json();
}

function mergeV1V2(v1, v2){
  const out = {};
  // v1 aynen
  Object.keys(v1 || {}).forEach(k => { out[String(k)] = v1[k]; });
  // v2 prefixli
  Object.keys(v2 || {}).forEach(k => { out["v2_" + String(k)] = v2[k]; });
  return out;
}

function sortGateKeys(keys){
  return keys.sort((a,b)=>{
    const aIsV2 = String(a).startsWith("v2_");
    const bIsV2 = String(b).startsWith("v2_");

    const na = Number(String(a).replace("v2_",""));
    const nb = Number(String(b).replace("v2_",""));

    // sayısal olanlar önce
    if(!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
    return String(a).localeCompare(String(b));
  });
}

async function loadGates(){
  try{
    setStatus("Kapılar yükleniyor...");

    const source = gateSourceSel.value; // "v1" | "v2" | "both"
    let v1 = {};
    let v2 = {};

    if(source === "v1" || source === "both"){
      const j1 = await fetchJson("/static/prompts/gates_v1.json");
      v1 = (j1 && j1.gates) ? j1.gates : {};
    }

    if(source === "v2" || source === "both"){
      const j2 = await fetchJson("/static/prompts/gates_v2.json");
      v2 = (j2 && j2.gates) ? j2.gates : {};
    }

    if(source === "v1"){
      GATES = v1;
    } else if(source === "v2"){
      // v2 tek başına bile prefixli
      GATES = mergeV1V2({}, v2);
    } else {
      // both
      GATES = mergeV1V2(v1, v2);
    }

    gateOrder = sortGateKeys(Object.keys(GATES));
    gateCountEl.textContent = String(gateOrder.length);

    closeGate();      // seçimi sıfırla
    renderGates();    // UI’ı bas
    setStatus("Hazır");
  } catch(e){
    console.error(e);
    setStatus("Kapılar yüklenemedi: " + String(e));
  }
}

// dropdown değişince tekrar yükle
gateSourceSel.addEventListener("change", loadGates);

// ilk yükleme
loadGates();

  // ---------- ask ----------
  async function askSanri(){
    const qEl = $("question");
    const ansEl = $("answer");
    if(!qEl || !ansEl) return;

    const q = (qEl.value || "").trim();
    if(!q) return;

    ansEl.style.display = "block";
    ansEl.textContent = "Yazıyor...";

    try {
      const res = await fetch("/bilinc-alani/ask", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          message: q,
          session_id: state.session_id || "default",
          mode: state.mode,
          domain: state.domain
        })
      });

      if(!res.ok){
        const t = await res.text();
        ansEl.textContent = "SERVER ERROR → " + t;
        return;
      }

      const data = await res.json();
      state.session_id = data.session_id || state.session_id;
      ansEl.textContent = data.response || "";

    } catch(e){
      ansEl.textContent = "HATA → " + String(e);
    }
  }

  // ---------- wire buttons ----------
  const readyBtn = $("readyBtn");
  const back2 = $("back2"); const next2 = $("next2");
  const back3 = $("back3"); const next3 = $("next3");
  const back4 = $("back4");
  const askBtn = $("askBtn");
  const trBtn = $("trBtn");
  const enBtn = $("enBtn");

  if(readyBtn) readyBtn.addEventListener("click", nextStep);
  if(back2) back2.addEventListener("click", prevStep);
  if(next2) next2.addEventListener("click", nextStep);
  if(back3) back3.addEventListener("click", prevStep);
  if(next3) next3.addEventListener("click", nextStep);
  if(back4) back4.addEventListener("click", prevStep);

  if(askBtn) askBtn.addEventListener("click", askSanri);

  if(trBtn) trBtn.addEventListener("click", () => setLang("tr"));
  if(enBtn) enBtn.addEventListener("click", () => setLang("en"));

  // Pill containers (senin HTML’de bu id’ler olmalı)
  wirePills("modeChoices");
  wirePills("fieldChoices");

  // init
  showStep(1);
})();
</script>