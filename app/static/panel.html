<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ask SANRI • Panel</title>
  <style>
    :root{
      --bg:#0e1116; --card:#141a22; --soft:#1b2230; --border:#2b3450;
      --gold:#d6b36a; --text:#e9edf3; --muted:#9aa4b2; --accent:#6fa8ff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background:radial-gradient(1200px 600px at 50% -10%, #1a2030 0%, #0e1116 60%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:18px;
    }
    .wrap{max-width:1200px;margin:0 auto;display:grid;gap:14px;grid-template-columns:420px 1fr}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg,#141a22,#0f141d);
      border:1px solid var(--border);
      border-radius:24px;
      padding:16px;
      box-shadow:0 24px 70px rgba(0,0,0,.45);
    }
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:50%;
      background:linear-gradient(135deg,#2a3246,#121826);
      display:grid;place-items:center;color:var(--gold);
      border:1px solid #2b3450;font-weight:700;
    }
    .title{font-weight:700;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted)}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:#101622;color:var(--muted);font-size:12px;
    }
    .pill b{color:var(--gold);font-weight:700}
    .select{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#101622;color:var(--text);outline:none;
    }
    .sectionTitle{font-weight:700;margin:10px 0 8px}
    #gateList{display:flex;flex-wrap:wrap;gap:8px}

    /* V1 – şehir kapıları */
    .gate-v1{
      background: linear-gradient(180deg,#141a22,#0f141d);
      border-color: #2b3450;
      color: #e9edf3;
    }
    /* V2 – özel kapılar */
    .gate-v2{
      background: linear-gradient(135deg,#d6b36a,#8f6b2e);
      border: none;
      color: #0b1020;
      font-weight: 700;
      box-shadow: 0 0 12px rgba(214,179,106,.35);
    }
    .gateBtn{
      cursor:pointer;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      font-size:12px;
    }
    .gateBtn.active{box-shadow:0 0 0 2px rgba(111,168,255,.18) inset}
    .gate-v2.active{
      box-shadow: 0 0 0 2px rgba(255,215,130,.9),
                  0 0 18px rgba(214,179,106,.6);
    }

    .kv{line-height:1.55;font-size:13px;color:#cfd7e7}
    .kv b{color:var(--text)}
    .kv .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      cursor:pointer;padding:10px 14px;border-radius:14px;border:1px solid var(--border);
      background:var(--soft);color:#fff;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{
      background:linear-gradient(135deg,#6fa8ff,#7c8cff);
      border:none;color:#0b1020;font-weight:700;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .chatlog{
      height:520px;overflow:auto;border:1px solid var(--border);
      border-radius:16px;padding:12px;background:#0f141d;white-space:pre-wrap;
    }
    .msg{margin:10px 0}
    .role{font-weight:800;margin-right:8px}
    .role.user{color:#b7d7ff}
    .role.assistant{color:#d8ffbf}
    textarea{
      width:100%;min-height:90px;resize:vertical;background:#0f141d;border:1px solid var(--border);
      border-radius:14px;color:#e9edf3;padding:12px;outline:none;
    }
    .note{
      border:1px solid var(--border);
      background:linear-gradient(180deg,#151c2a,#101624);
      border-radius:14px;padding:10px 12px;color:#c9d2e3;font-size:12px;margin-top:10px;
    }
    .mutedTiny{color:var(--muted);font-size:12px}
    .tokenRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tokenRow input{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#101622;color:var(--text);outline:none;min-width:220px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LEFT -->
  <div class="card">
    <header>
      <div class="brand">
        <div class="logo">∞</div>
        <div>
          <div class="title">CAELINUS</div>
          <div class="sub" id="planSub">Ask SANRI • Consciousness Mirror</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="tokenRow">
          <input id="tokenInput" placeholder="Token gir (opsiyonel)" />
          <button class="btn" id="tokenBtn" type="button">Doğrula</button>
        </div>

        <select id="gateSource" class="select" title="Kapı kaynağı">
          <option value="v1">gates_v1 (81 şehir)</option>
          <option value="v2">gates_v2 (V2 kapılar)</option>
          <option value="both" selected>both (v1 + v2)</option>
        </select>
      </div>
    </header>

    <div class="bar">
      <div class="pill">Aktif Kapı: <b id="activeGateLabel">Yok</b></div>
      <div class="pill">Kapı Sayısı: <b id="gateCount">0</b></div>
      <div class="pill">Durum: <b id="statusText">Hazır</b></div>
    </div>

    <div class="note">
      <b>Not:</b> SANRI kehanet/teşhis/yargı üretmez. Sembolik anlam ve tek soru ile fark ettirir.
      <div class="mutedTiny" style="margin-top:6px">Bu panel test içindir. AskSANRI web UI ayrı.</div>
    </div>

    <div class="sectionTitle">Kapılar</div>
    <div id="gateList"></div>

    <div class="sectionTitle">Kapı Kartı</div>
    <div class="kv">
      <div><b>Başlık:</b> <span id="gTitle" class="muted">-</span></div>
      <div><b>Tanrıça:</b> <span id="gGoddess" class="muted">-</span></div>
      <div><b>Faz:</b> <span id="gPhase" class="muted">-</span></div>
      <div><b>Element:</b> <span id="gElement" class="muted">-</span></div>
      <div><b>Misyon:</b> <span id="gMission" class="muted">-</span></div>
      <div><b>Kurallar:</b> <span id="gRules" class="muted">-</span></div>
      <div><b>Mantra:</b> <span id="gMantra" class="muted">-</span></div>
      <div><b>Ritüel:</b> <span id="gRitual" class="muted">-</span></div>
      <div id="gateHint" class="muted" style="margin-top:8px;font-size:12px">Kapı seçince detaylar burada görünür.</div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="lockBtn" disabled type="button">Kilitle (Bu kapıyla konuş)</button>
      <button class="btn" id="readMantraBtn" disabled type="button">Mantrayı Oku</button>
      <button class="btn" id="closeGateBtn" disabled type="button">Kapat</button>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <div class="sectionTitle">Sohbet <span class="muted" style="font-weight:500">• Ctrl+Enter gönderir</span></div>
    <div id="chatlog" class="chatlog"></div>

    <div style="margin-top:10px">
      <textarea id="message" placeholder="Mesaj yaz..."></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="sendBtn" type="button">Gönder</button>
        <button class="btn" id="clearBtn" type="button">Temizle</button>
      </div>
      <div class="mutedTiny" style="margin-top:10px">
        API: <span id="apiBaseView"></span>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ✅ SAME-ORIGIN: Panel hangi domainden açıldıysa API de orası
  // Böylece CORS bitiyor.
  const API_BASE = const API_BASE = "https://sanri-api-production-815e.up.railway.app";
  document.getElementById("apiBaseView").textContent = API_BASE;

  // DOM
  const gateSourceSel = document.getElementById("gateSource");
  const gateListEl = document.getElementById("gateList");
  const gateCountEl = document.getElementById("gateCount");
  const statusTextEl = document.getElementById("statusText");
  const activeGateLabelEl = document.getElementById("activeGateLabel");
  const planSub = document.getElementById("planSub");

  const tokenInput = document.getElementById("tokenInput");
  const tokenBtn = document.getElementById("tokenBtn");

  const gTitle = document.getElementById("gTitle");
  const gGoddess = document.getElementById("gGoddess");
  const gPhase = document.getElementById("gPhase");
  const gElement = document.getElementById("gElement");
  const gMission = document.getElementById("gMission");
  const gRules = document.getElementById("gRules");
  const gMantra = document.getElementById("gMantra");
  const gRitual = document.getElementById("gRitual");
  const gateHint = document.getElementById("gateHint");

  const lockBtn = document.getElementById("lockBtn");
  const readMantraBtn = document.getElementById("readMantraBtn");
  const closeGateBtn = document.getElementById("closeGateBtn");

  const chatlog = document.getElementById("chatlog");
  const msgInput = document.getElementById("message");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  // STATE
  let SANRI_TOKEN = null;
  let sessionId = "default";
  let activeGateKey = null;
  let gateLocked = false;
  let openedOnce = false;

  let GATES = {};
  let gateOrder = [];

  // helpers
  const safe = (v)=> (v===null||v===undefined) ? "" : String(v);
  const formatRules = (r)=> Array.isArray(r) ? r.filter(Boolean).map(String).join(" | ") : safe(r);
  const setStatus = (t)=> { statusTextEl.textContent = t || "Hazır"; };

  function addLine(role, text){
    const div = document.createElement("div");
    div.className = "msg";

    const r = document.createElement("span");
    r.className = "role " + (role === "assistant" ? "assistant" : "user");
    r.textContent = role + ":";

    const t = document.createElement("span");
    t.textContent = " " + (text ?? "");

    div.appendChild(r);
    div.appendChild(t);
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  function clearCard(){
    gTitle.textContent="-"; gGoddess.textContent="-"; gPhase.textContent="-";
    gElement.textContent="-"; gMission.textContent="-"; gRules.textContent="-";
    gMantra.textContent="-"; gRitual.textContent="-";
    gateHint.textContent="Kapı seçince detaylar burada görünür.";
  }

  function setCard(g){
    if(!g){ clearCard(); return; }
    gTitle.textContent = safe(g.baslik || g.title || "");
    gGoddess.textContent = safe(g.tanrica || g.goddess || "");
    gPhase.textContent = safe(g.faz || g.phase || "");
    gElement.textContent = safe(g.element || "");
    gMission.textContent = safe(g.mission || "");
    gRules.textContent = formatRules(g.rules);
    gMantra.textContent = safe(g.mantra || "");
    gRitual.textContent = safe(g.rituel || g.ritual || "");
    gateHint.textContent = "Kapı açık. ‘Kilitle’ ile sohbet bağlamını aktive et.";
  }

  function setActiveLabel(){
    if(!activeGateKey){ activeGateLabelEl.textContent="Yok"; return; }
    const g = GATES[activeGateKey];
    const isV2 = String(activeGateKey).startsWith("v2_");
    const layer = isV2 ? "✨ V2" : "• V1";
    const tag = safe(g?.plaka || activeGateKey);
    const name = safe(g?.sehir || g?.city || g?.baslik || g?.title || "");
    activeGateLabelEl.textContent = layer + " " + tag + (name ? (" " + name) : "");
  }

  function renderGates(){
    gateListEl.innerHTML = "";
    gateOrder.forEach(k=>{
      const g = GATES[k];
      const btn = document.createElement("button");
      btn.className = "gateBtn " + (String(k).startsWith("v2_") ? "gate-v2" : "gate-v1");
      const left = safe(g.plaka || k);
      const right = safe(g.sehir || g.city || g.baslik || g.title || "");
      btn.textContent = left + (right ? (" " + right) : "");
      if(k === activeGateKey) btn.classList.add("active");
      btn.addEventListener("click", ()=>openGate(k));
      gateListEl.appendChild(btn);
    });
    gateCountEl.textContent = String(gateOrder.length);
  }

  function openGate(k){
    activeGateKey = String(k);
    gateLocked = false;

    lockBtn.disabled = false;
    readMantraBtn.disabled = false;
    closeGateBtn.disabled = false;

    setCard(GATES[activeGateKey]);
    setActiveLabel();
    renderGates();
    setStatus("Kapı açıldı.");
  }

  function closeGate(){
    activeGateKey = null;
    gateLocked = false;

    lockBtn.disabled = true;
    readMantraBtn.disabled = true;
    closeGateBtn.disabled = true;

    clearCard();
    setActiveLabel();
    renderGates();
    setStatus("Kapı kapandı.");
  }

  function lockGate(){
    if(!activeGateKey) return;
    gateLocked = true;
    setStatus("Kapı kilitlendi. Mesajlar kapı bağlamıyla gidecek.");
  }

  function buildGatePrompt(g){
    if(!g) return "";
    const parts = [];
    parts.push("SEN SANRI'SIN. Bu bir KAPI bağlamıdır. Önce bunu uygula.");
    parts.push("KAPI: " + safe(g.plaka || activeGateKey) + " - " + safe(g.sehir || g.city || ""));
    if(g.baslik || g.title) parts.push("BASLIK: " + safe(g.baslik || g.title));
    if(g.tanrica) parts.push("TANRICA: " + safe(g.tanrica));
    if(g.faz) parts.push("FAZ: " + safe(g.faz));
    if(g.element) parts.push("ELEMENT: " + safe(g.element));
    if(g.mission) parts.push("MISSION: " + safe(g.mission));
    const rr = formatRules(g.rules);
    if(rr) parts.push("RULES: " + rr);
    if(g.mantra) parts.push("MANTRA: " + safe(g.mantra));
    if(g.rituel || g.ritual) parts.push("RITUEL: " + safe(g.rituel || g.ritual));
    parts.push("Cevap 1-4 cümle. Tanım yapma. Hatırlat, ayna tut. En fazla 1 soru.");
    return parts.join("\n");
  }

  async function fetchJson(path){
    // ✅ same-origin
    const r = await fetch(path, { cache: "no-store" });
    if(!r.ok) throw new Error(path + " → " + r.status);
    return r.json();
  }

  function normalizeV2Map(v2){
    const out = {};
    Object.keys(v2||{}).forEach(k=>{
      const kk = String(k);
      out[kk.startsWith("v2_") ? kk : ("v2_" + kk)] = v2[k];
    });
    return out;
  }

  function mergeMaps(v1, v2){
    const out = {};
    Object.keys(v1||{}).forEach(k=> out[String(k)] = v1[k]);
    Object.keys(v2||{}).forEach(k=> out[String(k)] = v2[k]);
    return out;
  }

  async function loadGates(){
    if(!openedOnce){
      openedOnce = true;
      addLine("assistant",
        "Bu bir cevap alanı değil.\n" +
        "Bu, kendinle karşılaştığın yer.\n" +
        "Hazır mısın?"
      );
    }

    setStatus("Kapılar yükleniyor...");
    try{
      const source = gateSourceSel.value;
      let v1 = {}, v2 = {};

      if(source === "v1" || source === "both"){
        const j1 = await fetchJson("/static/prompts/gates_v1.json");
        v1 = j1?.gates || {};
      }
      if(source === "v2" || source === "both"){
        const j2 = await fetchJson("/static/prompts/gates_v2.json");
        v2 = normalizeV2Map(j2?.gates || {});
      }

      if(source === "v1") GATES = v1;
      else if(source === "v2") GATES = v2;
      else GATES = mergeMaps(v1, v2);

      gateOrder = Object.keys(GATES).sort((a,b)=>{
        const strip = (x)=>String(x).startsWith("v2_") ? String(x).slice(3) : String(x);
        const na = Number(strip(a));
        const nb = Number(strip(b));
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
        return String(a).localeCompare(String(b));
      });

      closeGate();
      renderGates();
      setStatus("Hazır");
      planSub.textContent = "Ask SANRI • Consciousness Mirror";

    }catch(err){
      setStatus("Kapılar yüklenemedi");
      addLine("assistant", "Kapılar yüklenemedi. /static/prompts/... yolunu kontrol et.");
      console.log("Kapılar yüklenemedi:", err);
    }
  }

  async function sendChat(){
    const message = msgInput.value.trim();
    if(!message) return;

    addLine("user", message);
    msgInput.value = "";
    sendBtn.disabled = true;

    try{
      setStatus("Yazıyor...");

      let finalMessage = message;
      let domain = null;

      if(activeGateKey && gateLocked){
        const g = GATES[activeGateKey];
        finalMessage = buildGatePrompt(g) + "\nKULLANICI:\n" + message;
        domain = String(activeGateKey);
      }

      const headers = { "Content-Type": "application/json" };
      if(SANRI_TOKEN) headers["x-sanri-token"] = SANRI_TOKEN;

      const res = await fetch(API_BASE + "/bilinc-alani/ask", {
        method: "POST",
        headers,
        body: JSON.stringify({
          message: finalMessage,
          session_id: sessionId || "default",
          domain: domain,
          mode: "user"  //
        })
      });

      if(!res.ok){
        const t = await res.text();
        addLine("assistant", "SERVER ERROR → " + t);
        setStatus("Hata");
        return;
      }

      const data = await res.json();
      const reply = data.response || data.answer || data.reply || "";
      addLine("assistant", reply || "Buradayım.");
      setStatus("Hazır");

      if(data.session_id) sessionId = data.session_id;

    }catch(e){
      addLine("assistant", "HATA → " + (e?.message || String(e)));
      setStatus("Hata");
    }finally{
      sendBtn.disabled = false;
    }
  }

  function clearChat(){
    chatlog.innerHTML = "";
    setStatus("Temizlendi");
  }

  tokenBtn.addEventListener("click", ()=>{
    SANRI_TOKEN = (tokenInput.value || "").trim() || null;
    setStatus(SANRI_TOKEN ? "Token aktif" : "Guest mod");
  });

  gateSourceSel.addEventListener("change", loadGates);
  lockBtn.addEventListener("click", lockGate);
  closeGateBtn.addEventListener("click", closeGate);

  readMantraBtn.addEventListener("click", ()=>{
    if(!activeGateKey){ setStatus("Önce kapı seç."); return; }
    const g = GATES[activeGateKey];
    const mantra = safe(g?.mantra || "");
    if(!mantra){ setStatus("Bu kapıda mantra boş."); return; }
    addLine("assistant", "MANTRA:\n" + mantra);
  });

  sendBtn.addEventListener("click", sendChat);
  clearBtn.addEventListener("click", clearChat);

  msgInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      sendChat();
    }
  });

  // init
  clearCard();
  setActiveLabel();
  loadGates();
});
</script>